# UrbanRAG3D

## Description

UrbanRAG3D is a microservice for tracking, indexing and updating 3D objects detected in city point-cloud data. It uses:

* A custom 3D encoder service to convert raw point-clouds into embeddings
* Milvus for vector similarity search
* An LLM (GPT-4) to normalize metadata and decide whether to update or keep existing records

The service is exposed via FastAPI and fronted by Nginx behind four replicas, all orchestrated with Docker Compose.

## Features

* **3D Point-Cloud Encoding**
  Sends raw 3D points to an external encoder API and receives a fixed-length embedding.
* **Vector Search**
  Stores embeddings in Milvus and finds similar objects by semantic proximity.
* **LLM-Powered Metadata Handling**

  * Normalizes the `type` field into a canonical English label.
  * Decides whether to update existing objects based on season, time of day, bounding boxes and point-cloud quality.
* **Notifications**
  Emits a POST to a downstream API whenever a new object is created or an existing one is updated.
* **Streaming Filter Endpoints**
  Two endpoints that stream matching or non-matching object IDs based on a natural-language condition, with filtering logic generated by the LLM.
* **Scalable Deployment**
  Four FastAPI replicas behind Nginx, plus Milvus, in Docker Compose.

## Architecture

```
Client → Nginx → FastAPI App (×4 replicas)
                     ↓
              Milvus Vector Store
                     ↓
           External 3D Encoder API
                     ↓
        External New-Object Notification API
```

## Prerequisites

* Docker Engine v20+
* Docker Compose v1.27+
* An OpenAI API key with GPT-4 access
* Network access to the internal 3D encoder and new-object APIs

## Configuration

Create a file named `.env` in the project root with these values:

```
MILVUS_HOST=milvus
MILVUS_PORT=19530
VECTOR_DIM=256
```

# 3D encoder service
ENCODER_URL=http://inner-test.env:8922/3dpointsencoder

# Downstream new-object notification
NEW_OBJ_URL=http://inner-test.env:8922/new3dobject

# OpenAI settings
```
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_MODEL=gpt-4
```

Insert open ai api key. Adjust URLs or ports as needed.

## Installation

1. **Clone the repository**

   ```
   git clone https://your-repo-url/UrbanRAG3D.git
   cd UrbanRAG3D
   ```

2. **Create or verify `.env`** as described above.

3. **Build and start services**

   ```
   docker-compose up --build -d
   ```

   This launches:

   * **milvus** on port 19530
   * **app** (FastAPI) with four replicas
   * **nginx** on port 80, proxying to the app

## API Endpoints

### 1. Create or Update Object

* **Endpoint**: `POST /objects/new`
* **Request body**:

  ```
  {
    "id": "object_1234",
    "city": "City",
    "timestamp": "2025-07-17T14:23:00Z",
    "lat": 55.7558,
    "lon": 37.6173,
    "type": "car",
    "pointcloud": [[1.0, 2.0, 3.0], [1.1, 2.1, 3.1]],
    "bbox": [1.0, 2.0, 3.0, 0.5, 0.5, 1.5]
  }
  ```

* **Responses**:

  * **New object created**

    ```
    new object created
    ```
  * **Existing object kept** (returns metadata)

    ```
    {
      "id": "object_1234",
      "city": "City",
      "timestamp": "2025-07-17T14:23:00Z",
      "lat": 55.7558,
      "lon": 37.6173,
      "type": "Car",
      "bbox": [1.0, 2.0, 3.0, 0.5, 0.5, 1.5]
    }
    ```
  * **Existing object updated**

    ```
    object updated
    ```

### 2. Stream Included Object IDs

* **Endpoint**: `POST /objects/filter_by_rule/included/stream`
* **Request body**:

  ```
  { "condition": "mobile objects" }
  ```
* **Response**: A plain-text stream of object IDs (one per line) that match the condition.

### 3. Stream Excluded Object IDs

* **Endpoint**: `POST /objects/filter_by_rule/excluded/stream`
* **Request body**:

  ```
  { "condition": "non-ground objects" }
  ```
* **Response**: A plain-text stream of object IDs (one per line) that do **not** match the condition.

## Testing

* Open Swagger UI at [http://localhost/docs](http://localhost/docs)
* Use `curl` or any HTTP client to test endpoints.

## Shutdown

To stop and remove containers and volumes:

```
docker-compose down -v
```
